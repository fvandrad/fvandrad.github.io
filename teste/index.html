<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Manutenção - CB Twister</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a biblioteca Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Configuração do Tailwind (sem alterações) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'dashboard-primary': '#4F46E5', 
                        'dashboard-secondary': '#EC4899',
                        'dashboard-bg': '#F3F4F6', 
                        'dashboard-sidebar': '#FFFFFF', 
                    }
                }
            }
        }
    </script>
    
    <!-- Scripts do Firebase -->
    <script type="module">
        // Importações do Firebase App e Auth (Versão 11.6.1 conforme o ficheiro fornecido)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, // Adicionado para Registo
            signInWithEmailAndPassword,     // Adicionado para Login
            onAuthStateChanged,
            signOut, // Adicionado para funcionalidade de Logout
            sendPasswordResetEmail // NOVO: Adicionado para recuperação de senha
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // Importações do Firestore (Banco de Dados)
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            getDocs,
            setDoc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configuração e Inicialização do Firebase ---

        let app, db, auth; 
        let userId = null;
        let maintenanceData = []; 
        let maintenanceChartInstance = null; // Instância global para permitir atualização
        let isRegisterMode = false; // Estado para alternar entre Login e Registo
        let currentEditDocId = null; // ID do documento atualmente em edição (para edição única)
        
        const maintenanceCollectionName = "maintenance";
        const profileCollectionName = "profile";
        const motoDetailsDocId = "motoDetails"; 

        const appId = "default-app-id"; // Mantido como default
        
        // CONFIGURAÇÃO DO FIREBASE FORNECIDA PELO UTILIZADOR (cb-twister)
        const firebaseConfig = {
          apiKey: "AIzaSyDWtAHYdRH5k2xjmnw0EENi3G3gNJ_HlcY",
          authDomain: "cb-twister.firebaseapp.com",
          projectId: "cb-twister",
          storageBucket: "cb-twister.firebasestorage.app",
          messagingSenderId: "959803889287",
          appId: "1:959803889287:web:4ac90a9fd73a5da222ca22"
        };
        
        // URL DA IMAGEM PADRÃO FIXA (SOLICITADO PELO UTILIZADOR)
        const PERMANENT_MOTO_IMAGE_URL = "https://cmssaladeimprensa.honda.com.br//sites/default/files/styles/hd_exibicao/public/2021-08/3_CB%20250F%20Twister_MOV_%20%2827%29-min.jpg?itok=0S0b-DAV";


        // Dados originais (para popular na primeira vez)
        // NOVOS CAMPOS: value (valor do serviço) e url (link da nota fiscal)
        const rawMaintenanceData = [
            { km: 1000, item: "1. revisão, óleo, filtro", value: 150.00, url: "https://exemplo.com/nota/rev1.pdf" }, 
            { km: 3000, item: "óleo", value: 80.00, url: "" },
            { km: 6000, item: "2. revisão, óleo, filtro", value: 150.00, url: "" }, 
            { km: 9000, item: "óleo", value: 80.00, url: "" },
            { km: 12000, item: "filtro comb, ar, óleo, filtro", value: 220.00, url: "https://exemplo.com/nota/rev2.pdf" }, 
            { km: 14000, item: "óleo", value: 80.00, url: "" },
            { km: 16000, item: "óleo, filtro, fluído freios", value: 250.00, url: "https://exemplo.com/nota/freios.pdf" }, 
            { km: 17000, item: "pneus diablo rosso ii", value: 800.00, url: "https://exemplo.com/nota/pneus.pdf" },
            { km: 20000, item: "óleo e filtro", value: 150.00, url: "" }, 
            { km: 23000, item: "óleo e filtro", value: 150.00, url: "" },
            { km: 26000, item: "óleo e filtro", value: 150.00, url: "" }, 
            { km: 28000, item: "pneu dianteiro sport demon", value: 400.00, url: "https://exemplo.com/nota/pneu_d.pdf" },
            { km: 29000, item: "filtro comb, ar", value: 90.00, url: "" }, 
            { km: 30000, item: "óleo e filtro", value: 150.00, url: "" },
            { km: 30000, item: "pneu traseiro sport demon", value: 450.00, url: "https://exemplo.com/nota/pneu_t.pdf" }, 
            { km: 31000, item: "retrovisor direito", value: 50.00, url: "" },
            { km: 33000, item: "óleo e filtro", value: 150.00, url: "" }, 
            { km: 33885, item: "óleo", value: 80.00, url: "" },
            { km: 36750, item: "past. freio tras.", value: 110.00, url: "" }, 
            { km: 37500, item: "oléo e filtro", value: 150.00, url: "" }
        ];

        // --- Gemini API Configuration ---
        const GEMINI_API_KEY = ""; 
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        // --- FIM Gemini API Configuration ---

        // 2. Função principal de inicialização
        async function initializeAppFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                
                // Configura os listeners da UI (incluindo autenticação e scroll)
                setupNavigation();

                onAuthStateChanged(auth, async (user) => {
                    const loadingScreen = document.getElementById('loading-screen');
                    const authScreen = document.getElementById('auth-screen'); 
                    const mainContent = document.querySelector('main');
                    
                    // Garante que o conteúdo principal e auth-screen estão prontos
                    if (mainContent) mainContent.classList.remove('hidden');

                    if (user) {
                        // SUCCESS PATH: O utilizador está autenticado
                        console.log("Utilizador autenticado:", user.uid);
                        userId = user.uid;
                        
                        // Garante que o ecrã de carregamento é escondido IMEDIATAMENTE.
                        if (loadingScreen) loadingScreen.classList.add('hidden');
                        if (authScreen) authScreen.classList.add('hidden');
                        
                        // Atualizar display do utilizador logado
                        const userEmailDisplay = document.getElementById('user-display-email');
                        if (userEmailDisplay) userEmailDisplay.textContent = user.email || `ID: ${user.uid}`;
                        
                        // NOVO: Garantir que o email é salvo no perfil após o login
                        if (user.email) {
                            const profileDocPath = `artifacts/${appId}/users/${userId}/${profileCollectionName}/${motoDetailsDocId}`;
                            
                            // CORREÇÃO: Incluir todos os campos obrigatórios vazios para satisfazer as Regras de Segurança
                            // A regra espera modelo, ano, placa e ownerEmail.
                            const initialProfileData = {
                                ownerEmail: user.email,
                                modelo: '', 
                                ano: '',
                                placa: ''
                            };
                            
                            // Salva o email e os placeholders no perfil. Usa merge: true.
                            setDoc(doc(db, profileDocPath), initialProfileData, { merge: true })
                                .catch(e => console.error("Erro ao salvar email do usuário no perfil:", e));
                        }

                        // CHAMA SEM AWAIT: Inicia o carregamento e popula em segundo plano
                        seedInitialData(userId); 
                        setupFirestoreListeners();
                        

                    } else {
                        // LOGIN REQUIRED: Exibe a tela de login/registo
                        console.log("Nenhum utilizador logado. Requer Email/Senha.");
                        userId = null;
                        
                        // Esconde loading e mostra a tela de autenticação
                        if (loadingScreen) loadingScreen.classList.add('hidden');
                        if (authScreen) authScreen.classList.remove('hidden');
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                document.getElementById('loading-text').textContent = "Erro fatal. Verifique o console.";
            }
        }
        
        // --- UTILITÁRIO PARA MENSAGENS DE STATUS (NOVO) ---
        function showTempMessage(message, isError = false) {
            const statusContainer = document.getElementById('status-message-container');
            if (!statusContainer) return;

            statusContainer.textContent = message;
            statusContainer.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            statusContainer.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

            setTimeout(() => {
                statusContainer.classList.add('hidden');
                statusContainer.textContent = '';
            }, 4000);
        }
        
        // --- LÓGICA DE AUTENTICAÇÃO EMAIL/SENHA ---
        function showAuthError(message) {
            const errorMessage = document.getElementById('auth-error-message');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        async function handleAuthSubmit(event) {
            event.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const submitBtn = document.getElementById('auth-submit-btn');
            const errorMessage = document.getElementById('auth-error-message');
            errorMessage.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = isRegisterMode ? "A criar conta..." : "A entrar...";

            try {
                if (isRegisterMode) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged cuidará do resto
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged cuidará do resto
                }
            } catch (error) {
                console.error("Erro na autenticação:", error);
                let userMessage = "Erro desconhecido. Verifique se o método Email/Senha está ativo no Firebase Console.";
                // Adicionei 'auth/invalid-credential' para ter certeza que é tratado como um erro de credencial
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    userMessage = "Email ou senha inválidos. Por favor, verifique se o email e a senha estão corretos.";
                } else if (error.code === 'auth/invalid-email') {
                    userMessage = "Formato de email inválido.";
                } else if (error.code === 'auth/email-already-in-use') {
                    userMessage = "Este email já está registado.";
                } else if (error.code === 'auth/weak-password') {
                    userMessage = "Senha fraca. Deve ter pelo menos 6 caracteres.";
                } else if (error.code === 'auth/operation-not-allowed') {
                    userMessage = "Autenticação por Email/Senha não está ativada no seu projeto Firebase.";
                }
                showAuthError(userMessage);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isRegisterMode ? "Criar Conta" : "Entrar";
            }
        }
        
        // NOVO: Função para enviar email de redefinição de senha
        async function handlePasswordReset() {
            const emailInput = document.getElementById('auth-email');
            const email = emailInput.value.trim();

            if (!email) {
                showAuthError("Por favor, digite seu email no campo acima para redefinir a senha.");
                return;
            }

            const resetBtn = document.getElementById('password-reset-btn');
            const originalText = resetBtn.textContent;
            resetBtn.disabled = true;
            resetBtn.textContent = "A enviar link...";
            showAuthError(""); // Limpa erros anteriores

            try {
                await sendPasswordResetEmail(auth, email);
                showTempMessage(`Link de redefinição enviado para ${email}. Verifique sua caixa de entrada e spam.`, false);
                // Limpa o campo de email após o envio bem-sucedido
                emailInput.value = '';
            } catch (error) {
                console.error("Erro ao enviar redefinição de senha:", error);
                let userMessage = "Erro ao processar o pedido. Tente novamente.";
                
                if (error.code === 'auth/user-not-found') {
                    userMessage = "Não encontramos um usuário com este email.";
                } else if (error.code === 'auth/invalid-email') {
                    userMessage = "Formato de email inválido.";
                }
                
                showAuthError(userMessage);
            } finally {
                resetBtn.disabled = false;
                resetBtn.textContent = originalText;
            }
        }
        
        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').textContent = isRegisterMode ? "Criar Nova Conta" : "Aceder com Email e Senha";
            document.getElementById('auth-submit-btn').textContent = isRegisterMode ? "Criar Conta" : "Entrar";
            document.getElementById('toggle-auth-mode').textContent = isRegisterMode ? "Já tem conta? Entrar." : "Não tem conta? Crie uma.";
            document.getElementById('auth-error-message').classList.add('hidden');
        }
        // --- FIM LÓGICA DE AUTENTICAÇÃO ---

        
        // --- Gemini API Text Correction Function (NOVO) ---
        async function correctTextAI(text) {
            if (!text || text.trim().length === 0) return text;

            const systemPrompt = "Você é um corretor ortográfico e gramatical. Corrija o texto fornecido garantindo que a ortografia e a gramática estejam perfeitas. Retorne APENAS o texto corrigido, sem qualquer introdução ou explicação.";
            const userQuery = text;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                config: {
                    temperature: 0.1, // Keep corrections literal
                }
            };
            
            const url = `${GEMINI_API_URL}?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    // Trim para remover quaisquer espaços em branco extras que o modelo possa adicionar
                    return generatedText.trim();
                } else {
                    console.warn("IA falhou na correção do texto, usando original:", text);
                    return text; 
                }

            } catch (error) {
                console.error("Erro ao chamar a API Gemini para correção:", error);
                // Retorna o texto original se a chamada falhar
                return text; 
            }
        }
        
        // 4. Função para popular dados iniciais (Manutenção) - AGORA ASSÍNCRONA E COM CORREÇÃO
        async function seedInitialData(currentUserId) {
            if (!currentUserId) return;
            
            // Manutenção
            const maintCollectionPath = `artifacts/${appId}/users/${currentUserId}/${maintenanceCollectionName}`;
            try {
                const querySnapshot = await getDocs(query(collection(db, maintCollectionPath)));
                if (querySnapshot.empty) {
                    console.log("A popular dados de manutenção...");
                    
                    // NEW: Corrigir itens antes de adicionar
                    const correctedDataPromises = rawMaintenanceData.map(async (entry) => {
                        const correctedItem = await correctTextAI(entry.item);
                        return {
                            ...entry,
                            item: correctedItem 
                        };
                    });

                    const correctedMaintenanceData = await Promise.all(correctedDataPromises);

                    const addPromises = correctedMaintenanceData.map(entry => {
                        return addDoc(collection(db, maintCollectionPath), {
                            km: entry.km, 
                            item: entry.item, 
                            value: entry.value, 
                            url: entry.url,     
                            createdAt: new Date()
                        });
                    });
                    await Promise.all(addPromises);
                    console.log("Dados de manutenção populados!");
                }
            } catch (error) {
                console.error("Erro ao popular dados de manutenção: ", error);
            }
        }

        // 5. Configura TODOS os Listeners do Firestore
        function setupFirestoreListeners() {
            if (!userId) return;

            // Listener 1: Dados de Manutenção (Coleção)
            const maintCollectionPath = `artifacts/${appId}/users/${userId}/${maintenanceCollectionName}`;
            const q = query(collection(db, maintCollectionPath));
            onSnapshot(q, (querySnapshot) => {
                console.log("Dados de manutenção recebidos!");
                const newMaintenanceData = [];
                querySnapshot.forEach((doc) => {
                    // Garante que os novos campos existem (com default)
                    newMaintenanceData.push({ 
                        id: doc.id, 
                        ...doc.data(),
                        value: doc.data().value || 0,
                        url: doc.data().url || '',
                    });
                });
                // Ordena sempre a lista principal por KM
                maintenanceData = newMaintenanceData.sort((a, b) => a.km - b.km);
                updateDashboardUI();
                renderFilteredBillingTable(); // Atualiza a tabela de faturamento filtrada
            }, (error) => console.error("Erro ao ouvir coleção de manutenção:", error));

            // Listener 2: Dados do Perfil/Configurações (Documento Único)
            const profileDocPath = `artifacts/${appId}/users/${userId}/${profileCollectionName}/${motoDetailsDocId}`;
            onSnapshot(doc(db, profileDocPath), (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Dados de perfil recebidos!");
                    const data = docSnap.data();
                    document.getElementById('moto-modelo').value = data.modelo || '';
                    document.getElementById('moto-ano').value = data.ano || '';
                    document.getElementById('moto-placa').value = data.placa || '';
                    
                    // Se houver uma URL no Firestore, usa-a. Caso contrário, usa a URL permanente.
                    const imageUrl = data.motoImageUrl || PERMANENT_MOTO_IMAGE_URL;
                    document.getElementById('moto-image-preview').src = imageUrl;
                } else {
                    console.log("Nenhum documento de perfil encontrado. (Será criado ao salvar)");
                    // Garante que a URL permanente é usada se não houver documento.
                    document.getElementById('moto-image-preview').src = PERMANENT_MOTO_IMAGE_URL;
                }
            }, (error) => console.error("Erro ao ouvir documento de perfil:", error));
        }

        // --- Funções de Atualização da UI (Dashboard) ---

        function updateDashboardUI() {
            if (maintenanceData.length === 0) {
                document.getElementById('lastServiceKm').textContent = `N/A`;
                document.getElementById('lastServiceItem').textContent = "Sem registos";
                document.getElementById('nextServiceKm').textContent = `N/A`;
                document.getElementById('maintenanceTableBody').innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Nenhum registo.</td></tr>`;
            } else {
                updateStatsCards();
                renderMaintenanceTable();
            }
            renderMaintenanceChart();
        }

        function updateStatsCards() {
            const lastService = maintenanceData[maintenanceData.length - 1];
            
            // 1. Atualizar Último Serviço
            document.getElementById('lastServiceKm').textContent = `${(lastService.km || 0).toLocaleString('pt-br')} Km`;
            const itemText = (lastService.item || 'N/A').charAt(0).toUpperCase() + (lastService.item || 'N/A').slice(1);
            document.getElementById('lastServiceItem').textContent = itemText;
            
            // 2. Calcular Intervalo Dinâmico de Troca de Óleo
            // Filtra por 'óleo' ou 'oleo' (case insensitive)
            const oilChangesKm = maintenanceData
                .filter(entry => (entry.item || '').toLowerCase().includes('óleo') || (entry.item || '').toLowerCase().includes('oleo'))
                .map(entry => entry.km || 0)
                .filter(km => km > 0)
                .sort((a, b) => a - b); // Ordena para garantir que a última seja a maior KM

            let lastOilChangeKm = 0;
            let dynamicInterval = 3000; // Intervalo padrão se não houver histórico
            let intervals = [];

            if (oilChangesKm.length > 0) {
                // Pega a ÚLTIMA quilometragem registrada para troca de óleo (a mais alta)
                lastOilChangeKm = oilChangesKm[oilChangesKm.length - 1]; 

                // Calcular todos os intervalos encontrados
                for (let i = 1; i < oilChangesKm.length; i++) {
                    intervals.push(oilChangesKm[i] - oilChangesKm[i-1]);
                }
                
                // Calcular intervalo médio
                if (intervals.length > 0) {
                    const sum = intervals.reduce((a, b) => a + b, 0);
                    // Arredondar para a centena mais próxima para uma exibição limpa
                    dynamicInterval = Math.round((sum / intervals.length) / 100) * 100; 
                    // Garante que o intervalo é razoável (entre 1000km e 6000km)
                    dynamicInterval = Math.max(1000, Math.min(6000, dynamicInterval)); 
                }
            } else {
                // Se não houver trocas de óleo registradas, usa o KM da última manutenção
                lastOilChangeKm = lastService.km || 0; 
            }
            
            // 3. Calcular Próximo Serviço KM (Último KM + Intervalo Calculado)
            const nextOilChange = (lastOilChangeKm || 0) + dynamicInterval;
            
            // 4. Se a última troca de óleo for zero, o "próximo" também deve ser N/A
            if (lastOilChangeKm === 0) {
                 document.getElementById('nextServiceKm').textContent = `N/A`;
                 document.getElementById('nextServiceIntervalDisplay').textContent = `(Sem histórico de óleo)`;
                 return;
            }


            // 5. Atualizar UI com Valores Dinâmicos
            document.getElementById('nextServiceKm').textContent = `~${nextOilChange.toLocaleString('pt-br')} Km`;
            document.getElementById('nextServiceIntervalDisplay').textContent = `(Estimativa: +${dynamicInterval.toLocaleString('pt-br')} Km)`;

        }
        
        // REMOVIDA A FUNÇÃO groupDataByKm (para desagrupar a tabela de histórico)

        function renderMaintenanceTable() {
            const tableBody = document.getElementById('maintenanceTableBody');
            tableBody.innerHTML = '';
            
            // Usa o array maintenanceData diretamente (já está ordenado por KM)
            if (maintenanceData.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Nenhum registo.</td></tr>`;
                 return;
            }
            
            // Itera sobre a lista completa
            maintenanceData.forEach(entry => {
                const itemFormatted = (entry.item || '').charAt(0).toUpperCase() + (entry.item || '').slice(1);
                const singleDocId = entry.id; // Agora cada linha tem um ID único
                const singleValue = entry.value || 0;
                const singleUrl = entry.url || '';
                
                const hasUrl = singleUrl && singleUrl.startsWith('http');
                
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${(entry.km || 0).toLocaleString('pt-br')}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${itemFormatted}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-end space-x-2">
                        <!-- Botão URL/Nota Fiscal -->
                        ${hasUrl ? 
                            `<a href="${singleUrl}" target="_blank" class="text-green-500 hover:text-green-700" title="Ver Nota Fiscal (R$ ${singleValue.toFixed(2)})">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm0 3a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                            </a>` : 
                            `<span class="text-gray-300" title="Sem Nota Fiscal"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm0 3a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></span>`
                        }

                        <!-- Botão Editar (Individual) -->
                        <button class="edit-single-btn text-blue-500 hover:text-blue-700" 
                                data-id="${singleDocId}" 
                                data-km="${entry.km}" 
                                data-item="${itemFormatted}" 
                                data-value="${singleValue}" 
                                data-url="${singleUrl}"
                                title="Editar Registo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-4.414 7.07l.707.707 2.828-2.828-.707-.707-2.828 2.828zm-4.243 4.243L8.586 10l-4.414 4.414-2.828-2.828 4.414-4.414-2.828-2.828L.757 12.757l4.414 4.414z"/></svg>
                        </button>
                        <!-- Botão Apagar -->
                        <button class="delete-btn text-red-500 hover:text-red-700" data-ids="${singleDocId}" title="Apagar Registo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>`;
                tableBody.appendChild(row);
            });
        }
        
        // NOVO: Renderiza a tabela de faturamento (AGORA É FILTRO DE MANUTENÇÃO)
        function renderFilteredBillingTable() {
            const tableBody = document.getElementById('filteredBillingTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            // Filtra os registos de manutenção que possuem URL/Nota Fiscal
            const filteredData = maintenanceData.filter(entry => entry.url && entry.url.startsWith('http'));

            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhum registo com Nota Fiscal.</td></tr>`;
                return;
            }
            
            filteredData.forEach(entry => {
                const valueFormatted = (entry.value || 0).toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
                // Note: Firestore Timestamp needs .toDate() if retrieved directly, but often appears as an object with toDate() method.
                const dateOnly = entry.createdAt ? (entry.createdAt.toDate ? new Date(entry.createdAt.toDate()) : new Date(entry.createdAt)).toLocaleDateString('pt-BR') : 'N/A'; // Usando a data de criação/inserção
                
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${dateOnly}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${entry.item || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${valueFormatted}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm flex justify-end space-x-2">
                        
                        <!-- Botão Editar (Individual - Usando o modal de Manutenção) -->
                        <button class="edit-single-btn text-blue-500 hover:text-blue-700" 
                                data-id="${entry.id}" 
                                data-km="${entry.km}" 
                                data-item="${entry.item}" 
                                data-value="${entry.value}" 
                                data-url="${entry.url}"
                                title="Editar Registo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-4.414 7.07l.707.707 2.828-2.828-.707-.707-2.828 2.828zm-4.243 4.243L8.586 10l-4.414 4.414-2.828-2.828 4.414-4.414-2.828-2.828L.757 12.757l4.414 4.414z"/></svg>
                        </button>
                        
                        <a href="${entry.url || '#'}" target="_blank" class="text-dashboard-primary hover:underline font-medium flex items-center space-x-1" title="Abrir arquivo de referência">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm0 3a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                             <span>Ver Nota</span>
                        </a>
                        
                        <button class="delete-btn text-red-500 hover:text-red-700" data-ids="${entry.id}" title="Apagar Registo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }


        function renderMaintenanceChart() {
            const ctx = document.getElementById('maintenanceChart')?.getContext('2d');
            if (!ctx) return;

            // Usa maintenanceData diretamente (já ordenado por KM)
            const data = maintenanceData; 
            const chartLabels = [], chartIntervals = [];
            let lastKm = 0;

            data.forEach(entry => {
                const currentKm = entry.km || 0;
                // Apenas considera entradas com KM maior que o anterior para calcular o intervalo
                if (currentKm > lastKm) {
                    chartLabels.push(`${currentKm.toLocaleString('pt-BR')} Km`);
                    chartIntervals.push(currentKm - lastKm);
                    lastKm = currentKm;
                } else if (chartLabels.length === 0 && currentKm > 0) {
                     // Caso da primeira entrada > 0, onde o intervalo é o próprio KM (do 0 ao primeiro serviço)
                     chartLabels.push(`${currentKm.toLocaleString('pt-BR')} Km (Inicial)`);
                     chartIntervals.push(currentKm);
                     lastKm = currentKm;
                }
                // Se currentKm == lastKm, significa vários serviços no mesmo KM (quebra de agrupamento) - ignora para o gráfico de INTERVALO
            });
            
            // --- INÍCIO DA OTIMIZAÇÃO: ATUALIZAR CHART.JS EXISTENTE ---
            if (maintenanceChartInstance) {
                // Atualiza os dados e rótulos do gráfico existente
                maintenanceChartInstance.data.labels = chartLabels;
                maintenanceChartInstance.data.datasets[0].data = chartIntervals;
                // Usa 'none' para desativar a animação e reduzir o consumo de CPU na atualização
                maintenanceChartInstance.update('none'); 
                return;
            }
            // --- FIM DA OTIMIZAÇÃO ---

            const gradient = ctx.createLinearGradient(0, 0, 0, 320);
            gradient.addColorStop(0, 'rgba(79, 70, 229, 0.4)');
            gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

            // Cria o novo gráfico APENAS se não houver instância existente
            maintenanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: [{
                    label: 'Intervalo (Km)', data: chartIntervals,
                    borderColor: 'rgba(79, 70, 229, 1)', backgroundColor: gradient, borderWidth: 3,
                    pointBackgroundColor: 'rgba(79, 70, 229, 1)', pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgba(79, 70, 229, 1)',
                    pointRadius: 4, pointHoverRadius: 6, fill: true, tension: 0.4
                }]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Km Percorridos' } }, x: { title: { display: true, text: 'Odômetro' } } },
                    plugins: { legend: { display: false }, tooltip: {
                        backgroundColor: '#1F2937', titleColor: '#fff', bodyColor: '#fff', padding: 12, cornerRadius: 8, displayColors: false,
                        callbacks: {
                            title: (context) => `Odômetro: ${context[0].label}`,
                            label: (context) => `Intervalo: ${context.raw.toLocaleString('pt-BR')} Km`
                        }
                    }},
                    interaction: { intersect: false, mode: 'index' }
                }
            });
        }
        
        // --- FUNÇÕES DE INSIGHT DE IA ---
        
        // Exponential Backoff Utility (required for API calls)
        const initialDelayMs = 1000;
        const maxRetries = 3;

        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries < maxRetries) {
                    const delay = initialDelayMs * Math.pow(2, retries);
                    console.warn(`Rate limit hit (429). Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries < maxRetries) {
                    const delay = initialDelayMs * Math.pow(2, retries);
                    console.warn(`Fetch error. Retrying in ${delay}ms... Error: ${error.message}`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                throw new Error(`Failed to fetch from API after ${maxRetries} attempts: ${error.message}`);
            }
        }
        
        async function generateInsight() {
            if (maintenanceData.length === 0) {
                return "Não há dados de manutenção para analisar.";
            }

            // Serialize data for the model
            const dataString = maintenanceData
                .map(entry => `Km: ${entry.km || 0}, Item: ${entry.item || ''}, Valor: R$${entry.value || 0}, Nota URL: ${entry.url ? 'Sim' : 'Não'}`)
                .join('\n');

            const systemPrompt = "Aja como um analista de manutenção de veículos experiente e conciso. Você deve analisar o histórico de serviços e fornecer uma visão geral clara em Português. NÃO use Markdown, listas, títulos ou emojis, apenas texto corrido e bem estruturado em no máximo 150 palavras.";
            const userQuery = `Analise o histórico de manutenção da moto, forneça insights sobre a frequência de troca de óleo, itens que precisam de atenção futura, e se o padrão de manutenção parece adequado. Dados: \n\n${dataString}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                config: {
                    temperature: 0.5,
                }
            };
            
            const url = `${GEMINI_API_URL}?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    return generatedText;
                } else {
                    console.error("Estrutura de resposta da IA inesperada:", result);
                    return "Erro ao processar a resposta da IA.";
                }

            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                return "Erro de conexão com a IA. Tente novamente mais tarde.";
            }
        }

        async function handleGenerateInsight() {
            if (!userId) {
                showTempMessage("Faça login para gerar insights.", true);
                return;
            }
            
            const insightTextarea = document.getElementById('ai-insight-output');
            const generateBtn = document.getElementById('generate-insight-btn');
            const originalBtnText = generateBtn.innerHTML;
            
            // UI Feedback
            generateBtn.disabled = true;
            generateBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> A analisar...`;
            insightTextarea.textContent = "A recolher dados e a gerar análise... Aguarde.";
            openModal('aiInsightModal');

            try {
                const insight = await generateInsight();
                insightTextarea.textContent = insight;
            } catch (error) {
                insightTextarea.textContent = "Erro ao gerar o insight: " + error.message;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalBtnText;
            }
        }
        
        // --- FIM FUNÇÕES DE INSIGHT DE IA ---

        
        // --- FUNÇÕES DE EDIÇÃO EM MASSA (MANUTENÇÃO) ---
        
        // Converte array de objetos em string 'km; item; valor; url'
        function serializeMaintenanceData() {
            return maintenanceData
                .map(entry => `${entry.km || 0}; ${entry.item || ''}; ${entry.value || 0}; ${entry.url || ''}`)
                .join('\n');
        }

        // Converte string 'km; item; valor; url' em array de objetos
        function deserializeMaintenanceData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            const newEntries = [];
            const errors = [];

            lines.forEach((line, index) => {
                const parts = line.split(';');
                // Novo formato exige 4 partes: Km; Item; Valor; URL
                if (parts.length < 4) {
                    errors.push(`Linha ${index + 1}: Formato inválido. Use 'Km; Item; Valor; URL' (ex: 41000; Troca de óleo; 150.00; https://link.pdf).`);
                    return;
                }

                const km = parseInt(parts[0].trim());
                const item = parts[1].trim(); 
                const value = parseFloat(parts[2].trim());
                const url = parts.slice(3).join(';').trim(); // Aceita ; na URL, junta o resto

                if (isNaN(km) || km <= 0) {
                    errors.push(`Linha ${index + 1}: Quilometragem (${parts[0].trim()}) inválida.`);
                    return;
                }
                if (item.length === 0) {
                    errors.push(`Linha ${index + 1}: Item/Serviço vazio.`);
                    return;
                }
                if (isNaN(value) || value < 0) {
                    errors.push(`Linha ${index + 1}: Valor (${parts[2].trim()}) inválido.`);
                    return;
                }

                newEntries.push({ km, item, value, url });
            });

            return { entries: newEntries, errors };
        }
        
        // Handler para abrir o modal de edição em massa
        function handleEditHistory() {
            if (!userId) {
                showTempMessage("Faça login para editar o histórico.", true);
                return;
            }
            const serializedData = serializeMaintenanceData();
            document.getElementById('edit-history-textarea').value = serializedData;
            openModal('editHistoryModal');
        }

        // Handler para salvar o histórico editado (Massa) - COM CORREÇÃO
        async function handleSaveHistory(event) {
            event.preventDefault();
            if (!userId) return;

            const textarea = document.getElementById('edit-history-textarea');
            const saveBtn = document.getElementById('save-history-btn');
            const originalBtnText = saveBtn.textContent;

            const rawText = textarea.value;
            let { entries, errors } = deserializeMaintenanceData(rawText);

            if (errors.length > 0) {
                const errorMsg = "Erros de Formato (Verifique as linhas): " + errors.join("; ");
                showTempMessage(errorMsg, true);
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = "A corrigir dados em massa..."; // NEW: Correction state

            try {
                // NEW: Corrigir itens em massa antes de salvar
                const correctedEntriesPromises = entries.map(async (entry) => {
                    const correctedItem = await correctTextAI(entry.item);
                    return { ...entry, item: correctedItem };
                });
                
                const correctedEntries = await Promise.all(correctedEntriesPromises);
                
                saveBtn.textContent = "A salvar tudo..."; // Saving state

                const collectionPath = `artifacts/${appId}/users/${userId}/${maintenanceCollectionName}`;

                // 1. APAGAR TODOS os documentos existentes
                console.log("A apagar todos os registos antigos...");
                const oldDocsSnapshot = await getDocs(query(collection(db, collectionPath)));
                const deletePromises = [];
                oldDocsSnapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                await Promise.all(deletePromises);
                console.log("Registos antigos apagados.");

                // 2. ADICIONAR todas as novas entradas (corrigidas)
                if (correctedEntries.length > 0) {
                    console.log(`A adicionar ${correctedEntries.length} novos registos...`);
                    const addPromises = correctedEntries.map(entry => {
                        return addDoc(collection(db, collectionPath), {
                            km: entry.km,
                            item: entry.item, // Corrected item
                            value: entry.value, 
                            url: entry.url,     
                            createdAt: new Date() 
                        });
                    });
                    await Promise.all(addPromises);
                }
                
                closeModal('editHistoryModal');
                showTempMessage("Histórico de manutenção substituído com sucesso!", false);
                // O listener onSnapshot irá atualizar a UI automaticamente

            } catch (error) {
                console.error("Erro fatal ao substituir o histórico: ", error);
                showTempMessage("Falha fatal ao salvar o histórico. Verifique o console e as Regras de Segurança.", true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalBtnText;
            }
        }
        
        // --- FUNÇÕES DE EDIÇÃO INDIVIDUAL (MANUTENÇÃO) ---
        
        // 1. Abre o modal de edição individual e carrega os dados
        function handleEditEntry(button) {
            if (!userId) {
                showTempMessage("Faça login para editar.", true);
                return;
            }
            
            // Extrai os dados dos atributos do botão
            const docId = button.getAttribute('data-id');
            const km = button.getAttribute('data-km');
            const item = button.getAttribute('data-item'); 
            const value = button.getAttribute('data-value'); // NOVO
            const url = button.getAttribute('data-url');     // NOVO
            
            // Popula o modal
            document.getElementById('edit-single-km').value = km;
            document.getElementById('edit-single-item').value = item;
            document.getElementById('edit-single-value').value = value; // NOVO
            document.getElementById('edit-single-url').value = url;     // NOVO
            
            // Guarda o ID do documento para salvar
            currentEditDocId = docId;

            // Abre o modal
            openModal('editSingleEntryModal');
        }

        // 2. Handler para salvar a edição de um único registo - COM CORREÇÃO
        async function handleSaveSingleEntry(event) {
            event.preventDefault();
            if (!userId || !currentEditDocId) return;

            const km = parseInt(document.getElementById('edit-single-km').value);
            let item = document.getElementById('edit-single-item').value.trim();
            const value = parseFloat(document.getElementById('edit-single-value').value); // NOVO
            const url = document.getElementById('edit-single-url').value.trim();         // NOVO
            
            const saveBtn = document.getElementById('save-single-entry-btn');
            const originalBtnText = saveBtn.textContent;

            if (isNaN(km) || km <= 0 || item.length === 0 || isNaN(value) || value < 0) {
                showTempMessage("Quilometragem, Item ou Valor inválido.", true);
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = "A corrigir texto..."; // NEW: Show correction state

            try {
                // NEW: Correct the item before saving
                item = await correctTextAI(item);
                
                saveBtn.textContent = "A atualizar..."; // Show saving state

                const docPath = `artifacts/${appId}/users/${userId}/${maintenanceCollectionName}/${currentEditDocId}`;
                
                // Usa setDoc com merge para atualizar os campos
                await setDoc(doc(db, docPath), { 
                    km: km, 
                    item: item, // Corrected item
                    value: value, // NOVO
                    url: url      // NOVO
                }, { merge: true });
                
                showTempMessage("Registo atualizado com sucesso!", false);
                closeModal('editSingleEntryModal');
            } catch (error) {
                console.error("Erro ao atualizar o registo: ", error);
                showTempMessage("Falha ao atualizar: Verifique Regras de Segurança no Console.", true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalBtnText;
                currentEditDocId = null; // Limpa o ID
            }
        }
        
        // --- FUNÇÕES DE FATURAMENTO (AGORA APENAS VISUALIZAÇÃO) ---

        // Nenhuma função CRUD é necessária aqui, pois os dados são editados no Histórico Detalhado.
        
        // Handler para adicionar registo de MANUTENÇÃO (Adicionado Valor e URL) - COM CORREÇÃO
        async function handleAddEntry(event) {
            event.preventDefault();
            if (!userId) return;
            
            const form = event.target;
            const kmInput = form.elements['maintenance-km'];
            const itemInput = form.elements['maintenance-item'];
            const valueInput = form.elements['maintenance-value']; // NOVO
            const urlInput = form.elements['maintenance-url'];     // NOVO
            const button = form.elements['submit-button'];
            
            const km = parseInt(kmInput.value);
            let item = itemInput.value.trim();
            const value = parseFloat(valueInput.value) || 0;
            const url = urlInput.value.trim();

            if (!km || !item || km <= 0) {
                showTempMessage("Quilometragem e Item são obrigatórios.", true);
                return;
            }

            button.disabled = true; 
            button.textContent = "A corrigir texto..."; // NEW: Show correction state

            try {
                // NEW: Correct the item before saving
                item = await correctTextAI(item);
                
                button.textContent = "A guardar..."; // Show saving state

                const collectionPath = `artifacts/${appId}/users/${userId}/${maintenanceCollectionName}`;
                await addDoc(collection(db, collectionPath), { 
                    km: km, 
                    item: item, // Corrected item
                    value: value, 
                    url: url,
                    createdAt: new Date() 
                });
                form.reset();
                closeModal('addEntryModal');
                showTempMessage("Registo de manutenção guardado com sucesso!", false);
            } catch (error) {
                console.error("Erro ao adicionar documento: ", error);
                showTempMessage("Falha ao guardar: Verifique Regras de Segurança no Console.", true);
            } finally {
                button.disabled = false; button.textContent = "Guardar Registo";
            }
        }

        // Apagar registo de MANUTENÇÃO (MESMA LÓGICA)
        async function handleDeleteEntry(event) {
            const deleteButton = event.target.closest('.delete-btn');
            if (!deleteButton) return;
            
            // No novo esquema, idsToDelete deve ser apenas um ID
            const idsToDelete = deleteButton.getAttribute('data-ids').split(',');
            if (deleteButton.dataset.confirmed !== 'true') {
                deleteButton.dataset.confirmed = 'true';
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.332-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.698-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>`;
                deleteButton.title = "Clique para confirmar";
                setTimeout(() => {
                    if (deleteButton.dataset.confirmed === 'true') {
                        deleteButton.dataset.confirmed = 'false';
                        deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                        deleteButton.title = "Apagar Registo";
                    }
                }, 3000);
                return;
            }

            if (!userId) return;
            deleteButton.disabled = true;
            deleteButton.innerHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/${maintenanceCollectionName}`;
                // Como não estamos agrupando, idsToDelete sempre terá um único ID
                const deletePromises = idsToDelete.map(id => deleteDoc(doc(db, collectionPath, id)));
                await Promise.all(deletePromises);
                showTempMessage("Registo apagado com sucesso!", false);
            } catch (error) {
                console.error("Erro ao apagar: ", error);
                showTempMessage("Falha ao apagar: Verifique Regras de Segurança no Console.", true);
            }
        }
        
        // Guardar CONFIGURAÇÕES
        async function handleSaveSettings(event) {
            event.preventDefault();
            if (!userId) return;

            const button = document.getElementById('save-settings-btn');
            button.disabled = true;
            button.textContent = "A guardar...";

            const settingsData = {
                modelo: document.getElementById('moto-modelo').value,
                ano: document.getElementById('moto-ano').value,
                placa: document.getElementById('moto-placa').value,
                ownerEmail: auth.currentUser?.email || 'N/A' // Adiciona o email do usuário
            };

            try {
                const profileDocPath = `artifacts/${appId}/users/${userId}/${profileCollectionName}/${motoDetailsDocId}`;
                await setDoc(doc(db, profileDocPath), settingsData, { merge: true });
                console.log("Configurações guardadas!");
                showTempMessage("Configurações da moto guardadas com sucesso!", false);
            } catch (error) {
                console.error("Erro ao guardar configurações: ", error);
                showTempMessage("Falha ao guardar: Verifique Regras de Segurança no Console.", true);
            } finally {
                button.disabled = false;
                button.textContent = "Salvar Alterações";
            }
        }
        
        // NOVA Função: Logout
        async function handleLogout() {
            try {
                await signOut(auth);
                console.log("Logout bem-sucedido.");
            } catch (error) {
                console.error("Erro ao fazer logout: ", error);
            }
        }
        
        // Novo listener para lidar com cliques de edição/exclusão na tabela
        function handleTableActions(event) {
            const target = event.target.closest('button');
            if (!target) return;

            if (target.classList.contains('delete-btn')) {
                // Se o botão de apagar for clicado na tabela de Manutenção ou Faturamento (o mesmo botão)
                handleDeleteEntry(event);
            } else if (target.classList.contains('edit-single-btn')) {
                // Passa o botão (elemento) para extrair os dados
                handleEditEntry(target); 
            }
        }
        
        // --- FUNÇÃO DE SCROLL PARA O FAB (NOVO) ---
        let lastScrollY = 0; 
        const scrollThreshold = 100; // Distância mínima para começar a esconder

        function handleScroll() {
            const fab = document.getElementById('open-add-modal-btn');
            if (!fab) return;

            // Se o utilizador rolar para baixo E estiver fora da zona de topo (para não esconder no início)
            if (window.scrollY > lastScrollY && window.scrollY > scrollThreshold) {
                // Rolar para baixo - Esconder FAB (deslizar para fora)
                fab.classList.add('translate-y-full', 'opacity-0');
                fab.classList.remove('translate-y-0', 'opacity-100');
            } else if (window.scrollY < lastScrollY || window.scrollY < scrollThreshold) {
                // Rolar para cima OU perto do topo - Mostrar FAB (deslizar para dentro)
                fab.classList.remove('translate-y-full', 'opacity-0');
                fab.classList.add('translate-y-0', 'opacity-100');
            }
            
            lastScrollY = window.scrollY;
        }

        function setupScrollListener() {
            // Adiciona o listener de scroll ao iniciar
            window.addEventListener('scroll', handleScroll);
        }
        // --- FIM FUNÇÃO DE SCROLL PARA O FAB ---


        // --- Controlo de Navegação e Modais ---

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');
            const desktopLinks = document.querySelectorAll('.desktop-link');
            const mobileLinks = document.querySelectorAll('.mobile-link');
            const logoutBtn = document.getElementById('logout-btn');
            const authForm = document.getElementById('auth-form');
            const toggleBtn = document.getElementById('toggle-auth-mode');
            
            // Listeners do Modal de Adicionar Entrada (Manutenção)
            const addEntryModalBackdrop = document.getElementById('modal-backdrop');
            
            // Novos listeners do modal de edição em massa (Manutenção)
            const editHistoryBtn = document.getElementById('edit-history-btn');
            const saveHistoryForm = document.getElementById('edit-history-form');
            const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
            const editModalBackdrop = document.getElementById('edit-modal-backdrop');
            
            // Novos listeners do modal de edição única (Manutenção)
            const editSingleForm = document.getElementById('edit-single-entry-form');
            const closeSingleEditModalBtn = document.getElementById('close-single-edit-modal-btn');
            const singleEditModalBackdrop = document.getElementById('single-edit-modal-backdrop');

            // NOVOS Listeners do Modal de Insight da IA
            const generateInsightBtn = document.getElementById('generate-insight-btn');
            const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
            const aiModalBackdrop = document.getElementById('ai-modal-backdrop');
            
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    pages.forEach(page => page.classList.add('hidden'));
                    document.getElementById(pageId)?.classList.remove('hidden');
                    desktopLinks.forEach(l => l.classList.remove('active-link'));
                    mobileLinks.forEach(l => l.classList.remove('active-link-mobile'));
                    document.querySelectorAll(`.nav-link[data-page="${pageId}"]`).forEach(activeLink => {
                        if (activeLink.classList.contains('desktop-link')) activeLink.classList.add('active-link');
                        if (activeLink.classList.contains('mobile-link')) activeLink.classList.add('active-link-mobile');
                    });
                    window.scrollTo(0, 0);
                });
            });
            
            // Listeners do Modal de Adicionar Entrada (Manutenção)
            document.getElementById('open-add-modal-btn').addEventListener('click', () => openModal('addEntryModal'));
            document.getElementById('close-modal-btn').addEventListener('click', () => closeModal('addEntryModal'));
            if (addEntryModalBackdrop) addEntryModalBackdrop.addEventListener('click', () => closeModal('addEntryModal'));
            document.getElementById('add-entry-form').addEventListener('submit', handleAddEntry);
            
            // Listeners da Tabela e Configurações
            // Listener unificado para Ações (Delete e Edit Individual)
            document.getElementById('maintenanceTableBody').addEventListener('click', handleTableActions); 
            // NOVO: Adiciona listener de ação na tabela de Faturamento Filtrada
            document.getElementById('filteredBillingTableBody').addEventListener('click', handleTableActions); 
            document.getElementById('settings-form').addEventListener('submit', handleSaveSettings);
            
            // Listeners do Modal de Edição em Massa (Manutenção)
            if (editHistoryBtn) editHistoryBtn.addEventListener('click', handleEditHistory);
            if (saveHistoryForm) saveHistoryForm.addEventListener('submit', handleSaveHistory);
            if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', () => closeModal('editHistoryModal'));
            if (editModalBackdrop) editModalBackdrop.addEventListener('click', () => closeModal('editHistoryModal'));
            
            // Listeners do Modal de Edição Única (Manutenção)
            if (editSingleForm) editSingleForm.addEventListener('submit', handleSaveSingleEntry);
            if (closeSingleEditModalBtn) closeSingleEditModalBtn.addEventListener('click', () => closeModal('editSingleEntryModal'));
            if (singleEditModalBackdrop) singleEditModalBackdrop.addEventListener('click', () => closeModal('editSingleEntryModal'));

            // Listeners do Modal de Insight da IA (NOVOS)
            if (generateInsightBtn) generateInsightBtn.addEventListener('click', handleGenerateInsight);
            if (closeAiModalBtn) closeAiModalBtn.addEventListener('click', () => closeModal('aiInsightModal'));
            if (aiModalBackdrop) aiModalBackdrop.addEventListener('click', () => closeModal('aiInsightModal'));

            // NOVO: Listener de Scroll para o FAB
            setupScrollListener();

            // Listeners de Autenticação
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            if (authForm) authForm.addEventListener('submit', handleAuthSubmit);
            if (toggleBtn) toggleBtn.addEventListener('click', toggleAuthMode);
            
            // NOVO: Listener para redefinição de senha
            const resetBtn = document.getElementById('password-reset-btn');
            if (resetBtn) resetBtn.addEventListener('click', handlePasswordReset);
        }

        function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }

        document.addEventListener('DOMContentLoaded', initializeAppFirebase);

    </script>
    
    <style>
        /* Estilos da aplicação (sem alterações) */
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        .active-link { background-color: #EDE9FE; color: #4F46E5; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1), 0 2px 4px -1px rgba(79, 70, 229, 0.06); }
        .active-link-mobile { color: #4F46E5; }
        .shadow-lg-top { box-shadow: 0 -4px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="antialiased">

    <!-- ECRÃ DE CARREGAMENTO -->
    <div id="loading-screen" class="fixed inset-0 bg-dashboard-bg z-50 flex flex-col items-center justify-center">
        <svg class="animate-spin h-12 w-12 text-dashboard-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-700">A ligar ao banco de dados...</p>
    </div>

    <!-- NOVO ECRÃ DE LOGIN/REGISTO POR EMAIL E SENHA -->
    <div id="auth-screen" class="hidden fixed inset-0 bg-dashboard-bg z-50 flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-xl text-center">
             <!-- Icone -->
            <div class="p-2 bg-dashboard-primary rounded-lg text-white w-16 h-16 mx-auto flex items-center justify-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.99 1.75l-3.99 2.1V6.2c0 .48.3.9.73 1.05l3.26 1.15c.42.15.74.55.74 1V14.8l-3.99 2.1v-2.33c0-.48-.3-.9-.73-1.05l-3.26-1.15a1.1 1.1 0 01-.74-1V8.2L1 6.1v6.5l8 4.2 8-4.2V6.1l-6.01-3.15zM9 13.1l-3-1.05v1.73l3 1.05v-1.73zm1-1.05l-3-1.05V9.28l3 1.05v1.72zm1 1.05l3-1.05v-1.73l-3 1.05v1.73zm1-2.8l-3-1.05v-1.72l3 1.05v1.72zM13 6.9L10 5.85 7 6.9v1.72l3 1.05 3-1.05V6.9zM9 4.9l3 1.05 3-1.05-3-1.05-3 1.05z" clip-rule="evenodd" /></svg>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-6" id="auth-title">Aceder com Email e Senha</h1>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-dashboard-primary focus:border-dashboard-primary transition-colors">
                <input type="password" id="auth-password" placeholder="Senha" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-dashboard-primary focus:border-dashboard-primary transition-colors">
                
                <button type="submit" id="auth-submit-btn" class="w-full bg-dashboard-primary text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:opacity-50">
                    Entrar
                </button>
                 <!-- NOVO: Link para recuperação de senha -->
                <button type="button" id="password-reset-btn" class="w-full text-sm text-gray-500 hover:text-dashboard-primary mt-2 transition-colors">
                    Esqueceu a senha?
                </button>
            </form>
            <p id="auth-error-message" class="text-red-500 mt-3 hidden text-sm font-medium"></p>
            <button id="toggle-auth-mode" class="text-sm text-dashboard-primary mt-4 hover:underline">
                Não tem conta? Crie uma.
            </button>
        </div>
    </div>

    <!-- Barra Lateral (Sidebar) - VISÍVEL APENAS EM DESKTOP (md: e acima) -->
    <nav class="hidden md:flex md:w-20 bg-dashboard-sidebar p-4 md:flex-col md:items-center md:space-y-8 shadow-xl md:fixed md:top-0 md:left-0 md:h-full z-10">
        <!-- Logo/Icone Principal -->
        <div class="p-2 bg-dashboard-primary rounded-lg text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.99 1.75l-3.99 2.1V6.2c0 .48.3.9.73 1.05l3.26 1.15c.42.15.74.55.74 1V14.8l-3.99 2.1v-2.33c0-.48-.3-.9-.73-1.05l-3.26-1.15a1.1 1.1 0 01-.74-1V8.2L1 6.1v6.5l8 4.2 8-4.2V6.1l-6.01-3.15zM9 13.1l-3-1.05v1.73l3 1.05v-1.73zm1-1.05l-3-1.05V9.28l3 1.05v1.72zm1 1.05l3-1.05v-1.73l-3 1.05v1.73zm1-2.8l-3-1.05v-1.72l3 1.05v1.72zM13 6.9L10 5.85 7 6.9v1.72l3 1.05 3-1.05V6.9zM9 4.9l3 1.05 3-1.05-3-1.05-3 1.05z" clip-rule="evenodd" /></svg>
        </div>
        
        <!-- Itens de Navegação Desktop -->
        <div class="flex flex-col space-y-6 text-gray-500">
            <a href="#" class="nav-link desktop-link p-3 rounded-xl active-link" data-page="page-dashboard" title="Dashboard"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg></a>
            <a href="#" class="nav-link desktop-link p-3 hover:bg-violet-100 hover:text-dashboard-primary rounded-xl transition-colors" data-page="page-stats" title="Estatísticas"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2z" /></svg></a>
            <a href="#" class="nav-link desktop-link p-3 hover:bg-violet-100 hover:text-dashboard-primary rounded-xl transition-colors" data-page="page-billing" title="Faturamento"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></a>
            <a href="#" class="nav-link desktop-link p-3 hover:bg-violet-100 hover:text-dashboard-primary rounded-xl transition-colors" data-page="page-settings" title="Configurações"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></a>
        </div>
    </nav>

    <!-- Conteúdo Principal -->
    <main class="md:ml-20 pb-20 md:pb-0 p-4 md:p-6 lg:p-10 overflow-auto relative">
        
        <!-- Novo Container de Mensagem de Status (Fixo no topo) -->
        <div id="status-message-container" class="hidden fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 p-3 rounded-lg text-white shadow-lg z-50 transition-all duration-300 ease-out max-w-md font-semibold text-center"></div>

        <!-- *********************** -->
        <!-- TELA 1: DASHBOARD (Ativa) -->
        <!-- *********************** -->
        <div id="page-dashboard" class="page-content">
            <header class="mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Dashboard de Manutenção: CB Twister</h1>
                <p class="text-gray-500">Histórico de serviços e peças da sua moto.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Gráfico de Intervalos -->
                <div class="lg:col-span-2 bg-white p-4 md:p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Visão Geral: Intervalos de Manutenção (Km)</h2>
                    <div class="h-80"><canvas id="maintenanceChart"></canvas></div>
                </div>

                <!-- Estatísticas -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-gradient-to-br from-dashboard-primary to-indigo-700 text-white p-6 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">Última Manutenção</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                        </div>
                        <p class="text-4xl font-bold mt-2" id="lastServiceKm">A carregar...</p>
                        <p class="text-sm opacity-80 mt-1" id="lastServiceItem">A carregar...</p>
                    </div>
                    <div class="bg-gradient-to-br from-dashboard-secondary to-pink-600 text-white p-6 rounded-2xl shadow-lg">
                         <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">Próximo Serviço de Óleo</h3> <!-- Título alterado -->
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-70" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                        </div>
                        <p class="text-4xl font-bold mt-2" id="nextServiceKm">A carregar...</p>
                        <p class="text-sm opacity-80 mt-1" id="nextServiceIntervalDisplay">(Estimativa: +3.000 Km)</p>
                    </div>
                </div>

                <!-- Imagem da Moto -->
                <div class="lg:col-span-1 bg-white p-4 md:p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 w-full">Minha Moto</h2>
                    <img id="moto-image-preview" 
                         src="https://placehold.co/600x400/E0E7FF/4F46E5?text=Sem+Foto" 
                         alt="Foto da Moto CB Twister" 
                         class="rounded-lg object-cover w-full h-48 lg:h-full transition-opacity duration-300">
                </div>
                
                <!-- Tabela de Histórico -->
                <div class="lg:col-span-2 bg-white p-4 md:p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <h2 class="text-xl font-semibold text-gray-700">Histórico Detalhado</h2>
                        <div class="flex space-x-3">
                            <!-- BOTÃO DE INSIGHT DA IA (NOVO) -->
                            <button id="generate-insight-btn" class="bg-indigo-50 text-dashboard-primary px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-indigo-100 transition-colors flex items-center space-x-1" title="Gerar insights e análise do histórico">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3.35 3.35a1.5 1.5 0 01-2.122 0l-.707-.707a.5.5 0 00-.707 0l-1.5 1.5a.5.5 0 000 .707l.707.707a1.5 1.5 0 010 2.122l-3.35 3.35a2 2 0 11-2.828-2.828l3.35-3.35a1.5 1.5 0 012.122 0l.707.707a.5.5 0 00.707 0l1.5-1.5a.5.5 0 000-.707l-.707-.707a1.5 1.5 0 010-2.122l3.35-3.35zM4.75 14.25a.75.75 0 100-1.5.75.75 0 000 1.5zM15 6a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>
                                <span>Insight IA</span>
                            </button>
                            <!-- BOTão DE EDIÇÃO EM MASSA -->
                            <button id="edit-history-btn" class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors flex items-center space-x-1" title="Editar todo o histórico em formato texto">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-4.414 7.07l.707.707 2.828-2.828-.707-.707-2.828 2.828zm-4.243 4.243L8.586 10l-4.414 4.414-2.828-2.828 4.414-4.414-2.828-2.828L.757 12.757l4.414 4.414z"/></svg>
                                 <span>Editar Tudo</span>
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Km</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item / Serviço</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">A carregar dados...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Botão Flutuante (FAB) para ADICIONAR MANUTENÇÃO (AGORA COM SLIDE) -->
            <!-- Classes 'transition-all duration-300 transform' adicionadas para o deslize -->
            <!-- Classes 'translate-y-0 opacity-100' setadas via JS ao rolar para cima/topo -->
            <button id="open-add-modal-btn" 
                    class="fixed bottom-24 md:bottom-10 right-6 md:right-10 bg-dashboard-primary text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 transition-all duration-300 transform translate-y-0 opacity-100 hover:scale-110 z-20" 
                    title="Adicionar Novo Registo de Manutenção">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
            </button>
        </div>
        
        <!-- ***************************** -->
        <!-- TELA 2: ESTATÍSTICAS (Oculta) -->
        <!-- ***************************** -->
        <div id="page-stats" class="page-content hidden">
            <header class="mb-8"><h1 class="text-2xl md:text-3xl font-bold text-gray-800">Estatísticas</h1><p class="text-gray-500">Análise de custos e frequência de manutenção.</p></header>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg"><h2 class="text-xl font-semibold text-gray-700 mb-4">Custo por Km</h2><p class="text-3xl font-bold text-dashboard-primary">R$ 0,15</p><p class="text-gray-500 mt-1">Custo médio total (peças + serviços).</p></div>
                <div class="bg-white p-6 rounded-2xl shadow-lg"><h2 class="text-xl font-semibold text-gray-700 mb-4">Itens Mais Trocados</h2><ul class="list-disc list-inside text-gray-600 space-y-2"><li>Óleo e Filtro (10 vezes)</li><li>Filtro de Ar (2 vezes)</li><li>Pneus (2 conjuntos)</li></ul></div>
            </div>
        </div>
        
        <!-- *************************** -->
        <!-- TELA 3: FATURAMENTO (FILTRADO) -->
        <!-- *************************** -->
        <div id="page-billing" class="page-content hidden">
            <header class="mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Faturamento e Pagamentos</h1>
                <p class="text-gray-500">Registo de notas fiscais e valores pagos (registos com URL de referência).</p>
            </header>
            
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Notas Fiscais Registadas</h2>
                    <!-- A edição em massa não é ideal aqui, pois é um filtro, o botão foi removido -->
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data do Registo</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serviço / Item</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Pago</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações / Nota Fiscal</th>
                            </tr>
                        </thead>
                        <!-- ID do body atualizado para ser único e usado na função de renderização -->
                        <tbody id="filteredBillingTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">A carregar dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- FAB Removido: Adicionar Faturamento agora é feito no Dashboard/Manutenção -->
        </div>

        <!-- ****************************** -->
        <!-- TELA 4: CONFIGURAÇÕES (Oculta) -->
        <!-- ****************************** -->
        <div id="page-settings" class="page-content hidden">
            <header class="mb-8"><h1 class="text-2xl md:text-3xl font-bold text-gray-800">Configurações</h1><p class="text-gray-500">Gerencie sua conta e preferências.</p></header>
            <div class="bg-white p-6 rounded-2xl shadow-lg max-w-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Dados da Moto</h2>
                <form id="settings-form" class="space-y-4">
                    <div><label for="moto-modelo" class="block text-sm font-medium text-gray-700">Modelo</label>
                        <input type="text" id="moto-modelo" name="moto-modelo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="Honda CB Twister">
                    </div>
                    <div><label for="moto-ano" class="block text-sm font-medium text-gray-700">Ano</label>
                        <input type="text" id="moto-ano" name="moto-ano" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="2023">
                    </div>
                     <div><label for="moto-placa" class="block text-sm font-medium text-gray-700">Placa</label>
                        <input type="text" id="moto-placa" name="moto-placa" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="BRA2E19">
                    </div>
                    <button type="submit" id="save-settings-btn" class="w-full bg-dashboard-primary text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:opacity-50">
                        Salvar Alterações
                    </button>
                </form>
                
                <!-- Bloco de Logout ADICIONADO -->
                <div class="border-t border-gray-200 mt-6 pt-6">
                    <p class="text-sm text-gray-500 mb-2">Login ativo como:</p>
                    <p id="user-display-email" class="text-gray-700 font-semibold mb-4 truncate" title="ID do utilizador">A carregar...</p>
                    <button id="logout-btn" class="w-full bg-red-50 text-red-600 py-3 rounded-lg font-semibold hover:bg-red-100 transition-colors">
                        Sair (Logout)
                    </button>
                </div>

            </div>
        </div>
        
    </main>

    <!-- Barra de Navegação Inferior - VISÍVEL APENAS EM MOBILE (abaixo de md:) -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white p-2 flex justify-around items-center shadow-lg-top z-10">
        <a href="#" class="nav-link mobile-link flex flex-col items-center p-2 rounded-lg text-gray-500 active-link-mobile" data-page="page-dashboard" title="Dashboard"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg><span class="text-xs">Home</span></a>
        <a href="#" class="nav-link mobile-link flex flex-col items-center p-2 rounded-lg text-gray-500" data-page="page-stats" title="Estatísticas"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2z" /></svg><span class="text-xs">Stats</span></a>
        <a href="#" class="nav-link mobile-link flex flex-col items-center p-2 rounded-lg text-gray-500" data-page="page-billing" title="Faturamento"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span class="text-xs">Notas</span></a>
        <a href="#" class="nav-link mobile-link flex flex-col items-center p-2 rounded-lg text-gray-500" data-page="page-settings" title="Configurações"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="text-xs">Ajustes</span></a>
    </nav>
    
    <!-- MODAL para Adicionar Novo Registo (Manutenção) -->
    <div id="addEntryModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-30 p-4">
        <div id="modal-backdrop" class="absolute inset-0"></div>
        <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-md z-40">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Adicionar Novo Registo</h2>
            <form id="add-entry-form" class="space-y-4">
                <div>
                    <label for="maintenance-km" class="block text-sm font-medium text-gray-700">Quilometragem (Km) <span class="text-red-500">*</span></label>
                    <input type="number" id="maintenance-km" name="maintenance-km" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="Ex: 40500">
                </div>
                <div>
                    <label for="maintenance-item" class="block text-sm font-medium text-gray-700">Item ou Serviço <span class="text-red-500">*</span></label>
                    <input type="text" id="maintenance-item" name="maintenance-item" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="Ex: Óleo e filtro">
                </div>
                <div>
                    <label for="maintenance-value" class="block text-sm font-medium text-gray-700">Valor Pago (R$)</label>
                    <input type="number" id="maintenance-value" name="maintenance-value" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="Ex: 150.00 (Opcional)">
                </div>
                <div>
                    <label for="maintenance-url" class="block text-sm font-medium text-gray-700">URL de Referência (Nota/PDF)</label>
                    <input type="url" id="maintenance-url" name="maintenance-url" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="Ex: https://link.pdf (Opcional)">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <!-- REMOVIDO: onclick="closeModal('addEntryModal')" -->
                    <button type="button" id="close-modal-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" id="submit-button" class="bg-dashboard-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:opacity-50">Guardar Registo</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL de Edição em Massa do Histórico (Manutenção) -->
    <div id="editHistoryModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-30 p-4">
        <div id="edit-modal-backdrop" class="absolute inset-0"></div>
        <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-xl z-40">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Editar Histórico Completo</h2>
            <p class="text-sm text-red-600 mb-3 bg-red-50 p-2 rounded-lg font-medium">
                ATENÇÃO: A alteração aqui irá **substituir todos** os registos. Use o formato: <br>**`Km; Item; Valor; URL`** por linha.
            </p>
            <form id="edit-history-form" class="space-y-4">
                <textarea id="edit-history-textarea" rows="15" required class="font-mono text-sm w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary"></textarea>
                
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="close-edit-modal-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" id="save-history-btn" class="bg-dashboard-secondary text-white px-4 py-2 rounded-lg font-semibold hover:bg-pink-600 transition-colors disabled:opacity-50">Salvar Histórico</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL para Edição de Registo Único (Manutenção) -->
    <div id="editSingleEntryModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-30 p-4">
        <div id="single-edit-modal-backdrop" class="absolute inset-0"></div>
        <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-md z-40">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Editar Registo de Manutenção</h2>
            <form id="edit-single-entry-form" class="space-y-4">
                <div>
                    <label for="edit-single-km" class="block text-sm font-medium text-gray-700">Quilometragem (Km)</label>
                    <input type="number" id="edit-single-km" name="edit-single-km" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="Ex: 40500">
                </div>
                <div>
                    <label for="edit-single-item" class="block text-sm font-medium text-gray-700">Item ou Serviço</label>
                    <input type="text" id="edit-single-item" name="edit-single-item" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="Ex: Óleo e filtro">
                </div>
                 <div>
                    <label for="edit-single-value" class="block text-sm font-medium text-gray-700">Valor Pago (R$)</label>
                    <input type="number" id="edit-single-value" name="edit-single-value" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="Ex: 150.00">
                </div>
                <div>
                    <label for="edit-single-url" class="block text-sm font-medium text-gray-700">URL de Referência (Nota/PDF)</label>
                    <input type="url" id="edit-single-url" name="edit-single-url" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-dashboard-primary focus:border-dashboard-primary" placeholder="Ex: https://link.pdf">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="close-single-edit-modal-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" id="save-single-entry-btn" class="bg-dashboard-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:opacity-50">Guardar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- NOVO MODAL para Insight da IA -->
    <div id="aiInsightModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-30 p-4">
        <div id="ai-modal-backdrop" class="absolute inset-0"></div>
        <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-lg z-40">
            <h2 class="text-2xl font-bold text-dashboard-primary mb-4 flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3.35 3.35a1.5 1.5 0 01-2.122 0l-.707-.707a.5.5 0 00-.707 0l-1.5 1.5a.5.5 0 000 .707l.707.707a1.5 1.5 0 010 2.122l-3.35 3.35a2 2 0 11-2.828-2.828l3.35-3.35a1.5 1.5 0 012.122 0l.707.707a.5.5 0 00.707 0l1.5-1.5a.5.5 0 000-.707l-.707-.707a1.5 1.5 0 010-2.122l3.35-3.35zM4.75 14.25a.75.75 0 100-1.5.75.75 0 000 1.5zM15 6a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>
                <span>Insight de Manutenção (IA)</span>
            </h2>
            <div id="ai-insight-output" class="bg-gray-50 p-4 rounded-lg text-gray-700 min-h-[100px] whitespace-pre-wrap">
                Clique no botão "Insight IA" para gerar a análise.
            </div>
            
            <div class="flex justify-end pt-4">
                <button type="button" id="close-ai-modal-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Fechar</button>
            </div>
        </div>
    </div>


</body>
</html>
